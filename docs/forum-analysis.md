## Forum Section – Scenarios, Risks, and Recommendations

### 1. Architecture Overview

- **Pages**
  - `ForumPage` (`/forum`)\n    - Lists discussions (topics) with filters: sort option, category filter, date range, search query.\n    - Uses `useForumCategories` and `useForumTopics` (React Query → `fetchForumCategories` / `fetchForumTopics`).\n    - Infinite scroll (virtual \"load more\" by increasing `visibleCount` when bottom sentinel intersects).\n  - `CreateDiscussionPage` (`/forum/new`)\n    - Auth‑only page to create a new discussion.\n    - Uses `useForumCategories`, `useUser`, supabase client, Zod validation, rate limiting via `checkRateLimit`, and email notification function `send-discussion-moderation-email`.\n    - Newly created discussions are inserted into `forum_discussions` with `status = 'pending'` and then go through moderation.\n  - `ForumTopicPage` (`/forum/:topicId`)\n    - Displays a single discussion, comments, reactions, bookmark/follow state, and reply editor.\n    - Uses `fetchTopicById` (ForumTopic), `useForumComments` (ForumComment), `useDiscussionActions`, `useReactionCounts`, and Supabase for posting replies.\n  - Admin moderation pages (`/admin/moderation` etc.)\n    - Not user‑facing, but important for understanding status transitions for discussions and replies.

- **Data layer**
  - `forum_discussions` (Supabase, RLS‑protected)\n    - Stores topics: `id`, `title`, `content`, `author_name`, `user_id`, `category`, `tags[]`, `symbol`, `asset_type`, `status`, `is_pinned`, `is_featured`, counts (`reply_count`, `view_count`, `like_count`), timestamps.\n    - RLS and policies ensure only approved / visible discussions are returned to normal users (see migrations `*_discussion_moderation_status.sql` etc.).\n  - `forum_replies`\n    - Stores replies to discussions: `discussion_id`, `content`, `author_name`, `user_id`, `is_approved`, timestamps, reaction counts.\n  - `forum_categories`\n    - Category metadata (slug, name, description, aggregated counts).\n  - `profiles`\n    - Joined to `forum_discussions` and `forum_replies` to derive `display_name`, `avatar_url`, `reputation_score` for authors.\n  - RPC / triggers / functions\n    - Various Supabase SQL + edge functions for moderation notifications, reaction counts, and watchlist‑related discussion queries (e.g. `fetchDiscussionsForWatchlist`).

- **API helpers (`src/lib/api/forum.ts`)**
  - `fetchForumCategories()` – returns `ForumCategory[]`, with dev‑only mock fallback.\n  - `fetchForumTopics(categoryId?)` – returns `ForumTopic[]`, joining `forum_discussions` with `profiles`, mapping DB rows to typed topics.\n  - `fetchForumComments(topicId)` – returns `ForumComment[]`, joining `forum_replies` with `profiles`, filtering to `is_approved = true`.\n  - `fetchDiscussionsForWatchlist(userId)` – builds a list of symbols from watchlists and finds discussions whose `tags` overlap with those symbols.\n  - Dev mocks (`mockForumCategories`, `mockForumTopics`, `mockForumComments`) are used only when Supabase calls fail and `import.meta.env.DEV` is true.

- **Hooks**
  - `useForumTopics({ categoryId? })` – React Query wrapper over `fetchForumTopics`.\n  - `useForumComments({ topicId, enabled? })` – wrapper over `fetchForumComments`.\n  - `useForumCategories()` (not shown here, but similar) – wrapper over `fetchForumCategories`.\n  - `useDiscussionActions(topicId)` – handles bookmark/follow toggling via Supabase.\n  - `useReactionCounts` – fetches reaction aggregates for topics and comments.\n  - `useCollectibleBills` / `usePageBillCollection` – hook into the collectibles/\"bills\" system for gamification.

### 2. Key User Scenarios

1. **Browse forum discussions (`/forum`)**\n   - User lands on the forum homepage.\n   - Sees hero section, categories grid, trending topics, full list of discussions with infinite scroll.\n   - Can:\n     - filter by category,\n     - sort by newest/oldest/most active/trending/most liked/controversial,\n     - filter by time (today/week/month/year),\n     - search by text in title or author.\n   - Expected:\n     - Only visible (approved / allowed by RLS) discussions appear.\n     - Filters and sort combine intuitively (e.g. trending within a category).\n     - Performance remains smooth as the number of topics grows.

2. **View a single discussion (`/forum/:topicId`)**\n   - User clicks a topic card and opens full page.\n   - Sees:\n     - topic title, metadata (author, date, category, views, replies),\n     - full content, reactions,\n     - list of approved replies (with author avatars and reputations),\n     - controls to bookmark and follow the discussion (if signed in).\n   - Expected:\n     - Unauthorized users can read everything but cannot post or toggle bookmark/follow.\n     - Reaction counts and reply counts are consistent with the topic overview.\n     - If topic is pending/removed due to moderation, user sees a reasonable \"not found / access denied\" page (depending on policy).

3. **Create a new discussion (`/forum/new`)**\n   - User (signed in) opens create page.\n   - Fills title, content, selects category, optionally tags, ticker symbol and asset type.\n   - Submits form.\n   - Expected:\n     - Client‑side validation (Zod) enforces minimum title/content length.\n     - Server‑side rate limiting prevents abuse.\n     - Discussion is created in `forum_discussions` with `status = 'pending'`.\n     - Moderation email is sent; user sees a clear \"pending moderation\" screen and can return to forum or start another discussion.

4. **Reply to a discussion**\n   - User (signed in) writes a reply in the editor on `ForumTopicPage`.\n   - On submit:\n     - Edge function `validate-reply-content` is called with session token; content is checked server‑side.\n     - If valid, a row is inserted into `forum_replies` with `is_approved = false` (or true depending on moderation rules).\n     - React Query caches for comments, topic, and topic list are invalidated.\n   - Expected:\n     - Validation errors are shown in the user’s language via i18n keys.\n     - Pending replies are clearly marked or simply not shown until approved.\n     - No reply is lost silently if validation service is down.

5. **Bookmark and follow discussions**\n   - On `ForumTopicPage`, signed‑in users can:\n     - bookmark topic (add to bookmarks list),\n     - follow topic (receive notifications when new replies are posted).\n   - Expected:\n     - Buttons update state optimistically or quickly after server confirmation.\n     - No duplicate bookmarks or follows; proper messages on errors.\n     - Notifications are delivered according to user settings.

6. **Admin moderation workflow**\n   - Admins see pending discussions/replies, can approve, edit, or reject them.\n   - Expected:\n     - RLS and policies correctly allow admin actions while keeping regular users restricted.\n     - Status transitions update `forum_discussions.status` and counts/triggers (notifications) reliably.

### 3. Identified / Potential Issues

#### 3.1 Data Consistency and Visibility

- **RLS vs client assumptions**\n  - Client code (e.g. `fetchForumTopics`, `fetchDiscussionsForWatchlist`) assumes that RLS already filters discussions by visibility (status, user permissions).\n  - **Risk:** if RLS policy changes or is misconfigured, hidden/pending/removed discussions may leak into the UI or, наоборот, легальные обсуждения не попадут в выборку без явной ошибки.\n\n**Suggested approach**\n- Keep RLS as the source of truth for visibility, but:\n  - Consider explicitly filtering by `status = 'approved'` in `fetchForumTopics` and `fetchDiscussionsForWatchlist` if policy permits.\n  - Add small diagnostic UI for admins/dev environment that shows the counts of pending vs approved topics as a sanity check.\n

#### 3.2 Dev Mock Data Behaviour

- `fetchForumCategories`, `fetchForumTopics`, and `fetchForumComments` use dev‑only mocks (`mockForumCategories`, `mockForumTopics`, `mockForumComments`) when Supabase calls fail and `import.meta.env.DEV` is true.\n  - **Risk:** behaviour in local/dev can diverge significantly from production:\n    - category IDs in mocks may not match real slugs,\n    - mock topics/comments may hide issues with RLS or schema changes,\n    - developers may think \"всё работает\", хотя в реальной БД запросы ломаются.\n\n**Suggested improvements**\n- Keep mocks for initial development, but:\n  - Add console warnings when mocks are used (already partially present via `logger.error`).\n  - Optionally gate mocks behind a dedicated env flag (e.g. `VITE_USE_FORUM_MOCKS`) to make accidental reliance less likely.\n  - Periodically run local environment against a staging Supabase instance with real data to catch RLS/schema drift.

#### 3.3 Moderation Workflow Edge Cases

- **Pending discussions**\n  - New discussions are inserted with `status = 'pending'` and then moderated.\n  - Client invalidates `['forumTopics']` cache, but relies on RLS/policies for whether the pending discussion appears.\n  - **Risk:**\n    - If policies allow the author to see their own pending discussion, it may appear on the main forum list as if it were live.\n    - If policies hide pending discussions from everyone, including author, user might be confused after creation (\"куда пропал мой пост?\") – хотя мы показываем отдельную \"pending\"-страницу сразу после создания.\n\n- **Pending replies**\n  - Replies are stored with `is_approved = false` and filtered by `.eq('is_approved', true)` in `fetchForumComments`.\n  - **UX‑risk:** пользователь не видит собственный ответ до модерации, без явного индикатора в UI, кроме тоста \"pending\".\n\n**Suggested improvements**\n- For discussions:\n  - Decide explicitly: должны ли авторы видеть свои pending‑обсуждения в общем списке?\n    - Если да — добавить явное визуальное состояние (badge \"Pending review\"),\n    - Если нет — убедиться, что полиси это строго запрещают, и опираться только на экран подтверждения после создания.\n- For replies:\n  - Consider showing the user their own pending reply locally (UI‑ghost) с пометкой \"Awaiting moderation\", без включения в общий список из БД.\n  - That avoids confusion while keeping moderation logic intact.

#### 3.4 Performance and Query Volume

- **Topic list + infinite scroll**\n  - `ForumPage` fetches all visible topics for a (optional) category and then applies filters/sorting on the client.\n  - Infinite scroll just slices the array (`filteredAndSortedTopics.slice(0, visibleCount)`).\n  - **Risk:** as the forum grows, number of topics per category may become large → heavy client‑side sorting/filtering, long initial loads, big payloads.\n\n**Suggested improvements**\n- Introduce server‑side pagination and/or limit queries by date or count (e.g. `limit 200` + `offset`).\n- Expose simple query parameters for sort/date/search to the backend, so that DB can apply them efficiently instead of the client.\n- Keep infinite scroll for UX, but base it on paginated fetches rather than a single huge array.

#### 3.5 Search, Sorting, and Date Handling

- **Search query**\n  - Search filters only by `title` and `author` (case‑insensitive `includes`).\n  - **Risk:** topics heavily tagged by `symbol` or `tags` but with generic titles may not be discoverable via forum search.\n\n- **Date filtering**\n  - `dateFilter` uses `new Date(topic.date)` and compares to `filterDate` for today/week/month/year.\n  - `topic.date` originates from `topic.created_at` (ISO timestamp from Supabase).\n  - **Risk:** if `created_at` ever stores non‑ISO or timezone‑inconsistent values, the filter may behave unexpectedly (e.g. off‑by‑one around midnight).\n\n**Suggested improvements**\n- Extend search to also consider `tags` and/or `symbol`, possibly with lower weight.\n- If forum becomes multi‑timezone‑aware, consider normalizing dates server‑side to UTC and applying filters in UTC to avoid boundary issues.\n

#### 3.6 Watchlists, Recommendations, and Cross‑feature Coupling

- `fetchDiscussionsForWatchlist` ties watchlists (from markets) to forum discussions via `tags` overlap.\n  - **Risks:**\n    - If tags are not curated or consistent (e.g. free‑form user input), many relevant discussions may not show up.\n    - Conversely, very generic tags may produce noisy results.\n\n**Suggested improvements**\n- Encourage a convention where symbol tags are explicitly prefixed or normalised (e.g. always uppercase tickers).\n- Optionally maintain a separate `symbols[]` column for discussions, using it instead of generic `tags` for watchlist linkage.\n

#### 3.7 I18n / Localization

- Forum UI uses a dedicated `forum` namespace in `ui.json`, but:\n  - Error messages from server‑side validation (`validate-reply-content`) are mapped to keys via `getValidationErrorMessageKey`, which assumes stable error codes.\n  - Some fallback strings in components use hardcoded English defaults if translations are missing (e.g. `|| 'Categories'`).\n\n**Risks**\n- New validation rules added on the server without updating client mapping will surface as generic error messages.\n- Incomplete translations may cause a mix of languages on forum pages.\n\n**Suggested improvements**\n- Maintain a small contract doc between validation service and frontend: list of possible error codes and their i18n keys.\n- Periodically run an i18n lint/checker to find any `|| 'English fallback'` occurrences and replace them with proper translations.

### 4. Summary and Next Steps

- Forum is already quite feature‑rich: categories, filters, infinite scroll, moderation, replies, bookmarks/follows, integration with watchlists and collectibles.\n- The most important **technical** risks come from:\n  - dependence on RLS/policies without explicit client filtering,\n  - dev mock data potentially obscuring production issues,\n  - client‑side only filtering/sorting as data volumes grow.\n- The main **UX** risks are around moderation visibility (pending content), discoverability (search limited to title/author), and clarity of validation/moderation messages.\n\nIf we want to harden the forum for production scale, the next concrete steps could be:\n1. Introduce server‑side pagination and filtering for `fetchForumTopics`.\n2. Make moderation states more explicit in the UI (badges/ghost replies).\n3. Tighten the contract between validation services, RLS policies, and frontend expectations, documenting it in a short `docs/forum-moderation.md` in addition to this overview.\n+

